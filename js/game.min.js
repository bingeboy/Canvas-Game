for(var c=!0,e=!1,f=0,g=["ms","moz","webkit","o"],i=0;i<g.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[g[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[g[i]+"CancelAnimationFrame"]||window[g[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var b=(new Date).getTime(),d=Math.max(0,16-(b-f)),j=window.setTimeout(function(){a(b+d)},d);f=b+d;return j});
window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});function k(a){var b={color:"#fff",align:"center",size:15,x:n>>1,y:p>>1},d;for(d in b)a[d]=a[d]?a[d]:b[d];"undefined"===typeof a.text||0===a.text.length||(q&&(r.shadowColor="rgba(0,0,0,0)"),r.font=a.size+"px arial",b=r.measureText(a.text).width,r.fillStyle="rgba(0,0,0,0.7)",r.fillRect(a.x-(b>>1)-10,a.y-8,b+17,a.size+18),r.textAlign=a.align,r.textBaseline="top",r.fillStyle=a.color,r.fillText(a.text,a.x,a.y))}
function s(){var a=n>>1,b=~~(0.48*p),d=~~(0.75*p);q&&(r.shadowColor="rgba(0,0,0,0)");r.textBaseline="alphabetic";r.fillStyle="rgba(0,0,0,0.7)";r.fillRect(a-255,b-88,510,106);r.font="98px arial";r.fillStyle="#538";r.textAlign="center";r.fillText("SQUARE'D",a,b);r.font="100px arial";r.lineWidth=1;r.strokeStyle="#a7f";r.textAlign="center";r.strokeText("SQUARE'D",a,b);k({text:"Press space to start",y:d-18});k({text:"Controls: Arrow keys or W, A, S, D to move; Mouse to aim and fire",y:d+18});gameClock=
Date.now()}
function t(){gameClock=Date.now();u=0;v=1.3;w={x:~~(n/2),y:~~(p/2),d:100,s:e,p:e,q:e,r:e,v:e,c:25,f:[],B:function(){this.f.push({x:this.x,y:this.y,a:Math.atan2(x.x-this.x,x.y-this.y)})},w:function(){this.q&&(0<this.x&&!this.r)&&(this.x-=0.12*y);w.r&&(this.x<z.width&&!this.q)&&(this.x+=0.12*y);this.s&&(0<this.y&&!this.p)&&(this.y-=0.12*y);this.p&&(this.y<z.height&&!this.s)&&(this.y+=0.12*y);if(this.v&&0>=(this.c-=0.2*y))this.B(),this.c=25;var a,b,d,j;for(j in this.f){a=this.f[j];cacheIndex=~~(100*
a.a);a.x+=A[cacheIndex]*0.7*y;a.y+=B[cacheIndex]*0.7*y;for(d in C.b)if(b=C.b[d],void 0!==a&&a.x<b.x+b.size&&a.x>b.x-b.size&&a.y<b.y+b.size&&a.y>b.y-b.size&&"dead"!==b.status){b.d--;0<b.d?(b.status="wounded",b.x+=6*A[cacheIndex],b.y+=6*B[cacheIndex]):(b.status="dead",b.a=a.a,b.c=100,u++,b.o={x:a.x,y:a.y});this.f.splice(j,1);break}void 0!==a&&(0>a.x||a.x>z.width||0>a.y||a.y>z.height)&&this.f.splice(j,1)}},j:function(){var a;q&&(r.shadowColor="rgba(0,0,0,1)",r.shadowBlur=15,r.shadowOffsetX=0,r.shadowOffsetY=
0);r.fillStyle="#0f0";r.fillRect(w.x-4,w.y-4,8,8);q&&(r.shadowColor="rgba(255,255,0,1)");r.strokeStyle="rgba(255, 255, 255, 1)";r.lineWidth=4;r.beginPath();for(var b in this.f)a=~~(100*Math.atan2(w.x-~~this.f[b].x,w.y-~~this.f[b].y)),r.moveTo(~~this.f[b].x,~~this.f[b].y),r.lineTo(~~this.f[b].x+18*A[a],~~this.f[b].y+18*B[a]);r.stroke();r.closePath()}};C={b:{},m:{wanderChase:function(a){var a=C.b[a],b=Math.atan2(w.x-a.x,w.y-a.y);0>a.c&&(a.a=b,a.c=~~(3900*Math.random())+2300);b=~~(100*a.a);a.x+=A[b]*
a.speed*y;a.y+=B[b]*a.speed*y;a.c-=y},chase:function(a){a=C.b[a];a.a=Math.atan2(w.x-a.x,w.y-a.y);var b=~~(100*a.a);a.x+=A[b]*a.speed*y;a.y+=B[b]*a.speed*y},divebomb:function(a){var b=~~(100*C.b[a].a),a=C.b[a];a.x+=A[b]*a.speed*y;a.y+=B[b]*a.speed*y;if(0>a.x||a.x>z.width||0>a.y||a.y>z.height)a.d=0,a.c=0},wanderCurve:function(a){var b=C.b[a];0<b.i&&(b.i-=y,0>=b.i&&(b.i=6E3,b.k=0.04*Math.random()-0.02));b.a+=b.k;C.m.wander(a)},ringerHub:function(a){var b=C.b[a];if(b.t){for(var d=D/b.t,j=50*Math.random()+
50,m=[-1,1][Math.round(Math.random())]*(0.04*Math.random()+0.06),l=0;l<b.t;l++)C.n({x:b.x,y:b.y,size:32,a:l*d,g:a,c:1500,C:j,e:"ringer",color:"rgba(112,255,152",d:1,k:m,status:"alive",speed:b.speed,l:b.l-1});b.t=0}C.m.wanderCurve(a)},ringer:function(a){var b=C.b[a];if(""===b.g||"dead"===C.b[b.g].status)return b.e="wander",C.m.wander(a),c;var a=b.C,d=C.b[b.g];0<b.c&&(b.c-=y,a=(1500-b.c)/1500*b.C);var j=~~(100*b.a);b.x=B[j]*a+d.x;b.y=A[j]*a+d.y;b.a+=b.k;b.a>E&&(b.a-=D);b.a<-E&&(b.a+=D)},centipede:function(a){var b=
C.b[a];0<b.c&&(b.c-=y,0>=b.c&&b.l&&(C.n({x:b.z,y:b.A,z:b.z,A:b.A,size:b.size,a:b.a,i:6E3,k:0.04*Math.random()-0.02,g:a,c:200,e:"centipede",color:b.color,d:1,status:"alive",speed:b.speed,l:b.l-1}),b.l=0));if(""===b.g||"dead"===C.b[b.g].status)""!==b.g&&(b.g=""),b.color="rgba(220,0,220",C.m.wanderCurve(a);else{b.color="rgba(140,0,140";var a=C.b[b.g],d=b.x-a.x,j=b.y-a.y;b.speed=25<Math.sqrt(d*d+j*j)?0.112:0.05;b.a=Math.atan2(a.x-b.x,a.y-b.y);a=~~(100*b.a);b.x+=A[a]*b.speed*y;b.y+=B[a]*b.speed*y}},wander:function(a){a=
C.b[a];a.a>E&&(a.a-=D);a.a<-E&&(a.a+=D);0>a.x?0>a.a&&(a.a=-a.a):a.x>z.width&&0<a.a&&(a.a=-a.a);0>a.y?(a.a<-F&&(a.a=-F+(-F-a.a)),a.a>F&&(a.a=F+(F-a.a))):a.y>z.height&&(0>a.a&&a.a>-F&&(a.a=-F+(-F-a.a)),0<a.a&&a.a<F&&(a.a=F+(F-a.a)));var b=~~(100*a.a);a.x+=A[b]*a.speed*y;a.y+=B[b]*a.speed*y}},types:[{size:46,speed:0.042,d:1,color:"rgba(64,64,255",e:"wander",c:0,h:1},{size:22,speed:0.092,d:1,color:"rgba(255,100,0",e:"wander",c:0,h:1},{size:52,speed:0.022,d:3,color:"rgba(0,0,180",e:"chase",c:0,h:1},{size:22,
speed:0.052,d:4,color:"rgba(64,124,84",e:"ringerHub",c:6E3,h:0.1},{size:31,speed:0.112,d:1,color:"rgba(220,0,220",e:"centipede",c:200,h:0.1},{size:28,speed:0.09,d:2,color:"rgba(255,0,0",e:"wanderChase",c:3900,h:1},{size:20,speed:0.064,d:1,color:"rgba(0,255,255",e:"chase",c:0,h:1},{size:30,speed:0.17,d:1,color:"rgba(255,255,0",e:"divebomb",c:0,h:1},{size:42,speed:0.032,d:5,color:"rgba(0,0,80",e:"wander",c:0,h:1}],n:function(a){G++;var b="e"+G;this.b[b]=a;return b},w:function(){if(v>100*Math.random()){var a,
b=~~(4*Math.random());a=~~(Math.random()*Math.min(~~v,this.types.length-1));a=this.types[a];if(1===a.h||Math.random()<a.h){a={size:a.size,speed:a.speed,d:a.d,color:a.color,e:a.e,c:a.c,status:"alive"};switch(b){case 0:a.x=~~(Math.random()*z.width);a.y=0;break;case 1:a.x=~~(Math.random()*z.width);a.y=z.height;break;case 2:a.x=0;a.y=~~(Math.random()*z.height);break;case 3:a.x=z.width,a.y=~~(Math.random()*z.height)}a.a=Math.atan2(w.x-a.x,w.y-a.y);switch(a.e){case "ringerHub":a.t=~~(4*Math.random())+8;
a.k=0.04*Math.random()-0.02;a.i=6E3;this.n(a);break;case "centipede":a.g="";a.l=~~(10*Math.random())+8;a.z=a.x;a.A=a.y;a.k=0.04*Math.random()-0.02;a.i=6E3;this.n(a);break;default:this.n(a)}}}for(var d in C.b)b=this.b[d],void 0!==b&&"dead"!==b.status&&(this.m[b.e](d),b.x<w.x+(b.size>>1)&&(b.x>w.x-(b.size>>1)&&b.y<w.y+(b.size>>1)&&b.y>w.y-(b.size>>1))&&(clearInterval(H),I=e))},j:function(){var a=1,b,d,j,m,l;q&&(r.shadowBlur=5,r.shadowOffsetX=3,r.shadowOffsetY=3);for(var h in this.b)if(void 0!==this.b[h])if(l=
this.b[h].size,"dead"!==this.b[h].status)q&&(r.shadowColor="rgba(0,0,0,1)"),"wounded"!==this.b[h].status?m=this.b[h].color+",1)":(this.b[h].status="alive",m="rgba(255,255,255,1)"),r.fillStyle!==m&&(r.fillStyle=m),r.fillRect(~~this.b[h].x-(l>>1),~~this.b[h].y-(l>>1),l,l);else{var P=this.b[h].color;100===this.b[h].c&&(P="rgba(255,255,255");this.b[h].c-=0.1*y;m=this.b[h].c;if(0>=m)delete this.b[h];else{q&&(r.shadowColor="rgba(0,0,0,0)");if(90<m){a=3;r.strokeStyle="rgba(255, 255, 0, 1)";r.lineWidth=4;
r.beginPath();d=Math.random()*(110-m);for(j=Math.random()*(140-m);--a;)b=~~(628*Math.random()-314),r.moveTo(~~(this.b[h].o.x+A[b]*d),~~(this.b[h].o.y+B[b]*d)),r.lineTo(~~(this.b[h].o.x+A[b]*j),~~(this.b[h].o.y+B[b]*j));r.stroke();r.closePath()}cacheIndex=~~(100*this.b[h].a);this.b[h].x+=A[cacheIndex]*0.03*m;this.b[h].y+=B[cacheIndex]*0.03*m;a=(m/100).toFixed(2);r.fillStyle=P+","+a+")";l+=~~(l*((100-m)/100));r.fillRect(~~this.b[h].x-(l>>1),~~this.b[h].y-(l>>1),l,l)}}}}}
function J(){if(!I||K)return e;var a=Date.now();y=a-gameClock;v+=2E-5*y;L++;M+=y;gameClock=a;w.w();C.w();z.j();C.j();w.j();x.j();k({color:"#f0f",text:"Score: "+u,x:80,y:30});a=~~(L/(M/1E3));k({color:"#f0f",text:"FPS: "+a,x:80,y:55});q&&(50>a&&1E4<M)&&(r.shadowColor="rgba(0,0,0,0)",q=e);I||s();requestAnimationFrame(J)}var N,r,w={},z={},C={},v=0.7,u=0,H,I=e,K=e,E=Math.PI,F=Math.PI/2,D=2*Math.PI,n,p,B,A,O=200*D>>0,x={},y=0,L=0,M=0,q=c,G=0;gameClock=Date.now();A=[];
for(var Q=-O;Q<O;Q++)A[Q]=Math.sin(Q/100);B=[];for(Q=-O;Q<O;Q++)B[Q]=Math.cos(Q/100);n=900;p=660;N=document.getElementById("gamecanvas");r=N.getContext("2d");bgcanvas=document.getElementById("bgcanvas");bgctx=bgcanvas.getContext("2d");N.setAttribute("width",n);N.setAttribute("height",p);bgcanvas.setAttribute("width",n);bgcanvas.setAttribute("height",p);
function R(){var a=document.getElementById("bgimg");z.u={D:a,width:a.width,height:a.height};bgctx.drawImage(z.u.D,0,0,z.u.width,z.u.height,0,0,n,p)}document.getElementById("bgimg").onload=R;document.getElementById("bgimg").complete&&R();z={width:n,height:p,offset:{left:window.innerWidth/2-N.width/2,top:N.offsetTop},F:"gravel.png",j:function(){q&&(r.shadowColor="rgba(0,0,0,0)");N.width=N.width}};
x={x:0,y:0,j:function(){q&&(r.shadowColor="rgba(0,0,0,0)");r.strokeStyle="#0ff";r.strokeRect(x.x-4,x.y-4,8,8)}};q&&(r.shadowColor="rgba(0,0,0,0)");r.fillStyle="#000";r.fillRect(0,0,n,p);document.onmousemove=function(a){x.x=(a.pageX-z.offset.left)/1;x.y=(a.pageY-z.offset.top)/1};document.onmousedown=function(a){w.B();w.v=c;w.c=20;a.stopPropagation();return e};document.onmouseup=function(){w.v=e};
window.onkeydown=function(a){switch(a.keyCode){case 38:case 87:w.s=c;break;case 37:case 65:w.q=c;break;case 39:case 68:w.r=c;break;case 40:case 83:w.p=c;break;case 32:I?K?(gameClock=Date.now(),K=e,requestAnimationFrame(J)):(k({text:"PAUSED",size:60,color:"#538"}),k({text:"Press space to unpause.",y:(p>>1)+100}),K=c,M=L=0):(I=c,t(),requestAnimationFrame(J))}};
window.onkeyup=function(a){switch(a.keyCode){case 38:case 87:w.s=e;break;case 37:case 65:w.q=e;break;case 39:case 68:w.r=e;break;case 40:case 83:w.p=e}};s();t();
