(function(){for(var n=0,u=["ms","moz","webkit","o"],g=0;g<u.length&&!window.requestAnimationFrame;++g)window.requestAnimationFrame=window[u[g]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[u[g]+"CancelAnimationFrame"]||window[u[g]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(g){var k=(new Date).getTime(),c=Math.max(0,16-(k-n)),f=window.setTimeout(function(){g(k+c)},c);n=k+c;return f});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(g){clearTimeout(g)})})();(function(){function n(a){var b={color:"#fff",align:"center",size:15,x:p>>1,y:m>>1},d;for(d in b)a[d]=a[d]?a[d]:b[d];if("undefined"===typeof a.text||0===a.text.length)return!1;j&&(c.shadowColor="rgba(0,0,0,0)");c.font=a.size+"px arial";b=c.measureText(a.text).width;c.fillStyle="rgba(0,0,0,0.7)";c.fillRect(a.x-(b>>1)-10,a.y-8,b+17,a.size+18);c.textAlign=a.align;c.textBaseline="top";c.fillStyle=a.color;c.fillText(a.text,a.x,a.y)}function u(){var a=p>>1,b=~~(0.48*m),d=~~(0.75*m);j&&(c.shadowColor="rgba(0,0,0,0)");
c.textBaseline="alphabetic";c.fillStyle="rgba(0,0,0,0.7)";c.fillRect(a-255,b-88,510,106);c.font="98px arial";c.fillStyle="#538";c.textAlign="center";c.fillText("SQUARE'D",a,b);c.font="100px arial";c.lineWidth=1;c.strokeStyle="#a7f";c.textAlign="center";c.strokeText("SQUARE'D",a,b);n({text:"Press space to start",y:d-18});n({text:"Controls: W, A, S, D to move; Mouse to aim and fire",y:d+18});w=Date.now()}function g(){w=Date.now();C=0;x=0.7;f={x:~~(p/2),y:~~(m/2),hp:100,moveUp:!1,moveDown:!1,moveLeft:!1,
moveRight:!1,firing:!1,cooldown:25,bullets:[],fireShot:function(){this.bullets.push({x:this.x,y:this.y,angle:Math.atan2(t.x-this.x,t.y-this.y)})},logic:function(){this.moveLeft&&(0<this.x&&!this.moveRight)&&(this.x-=0.12*i);f.moveRight&&(this.x<e.width&&!this.moveLeft)&&(this.x+=0.12*i);this.moveUp&&(0<this.y&&!this.moveDown)&&(this.y-=0.12*i);this.moveDown&&(this.y<e.height&&!this.moveUp)&&(this.y+=0.12*i);if(this.firing&&0>=(this.cooldown-=0.2*i))this.fireShot(),this.cooldown=25;for(var a in this.bullets){var c=
~~(100*this.bullets[a].angle);this.bullets[a].x+=q[c]*0.5*i;this.bullets[a].y+=r[c]*0.5*i;for(var d in b.enemy)if(void 0!==this.bullets[a]&&this.bullets[a].x<b.enemy[d].x+b.enemy[d].size&&this.bullets[a].x>b.enemy[d].x-b.enemy[d].size&&this.bullets[a].y<b.enemy[d].y+b.enemy[d].size&&this.bullets[a].y>b.enemy[d].y-b.enemy[d].size&&0<b.enemy[d].hp){--b.enemy[d].hp||(b.enemy[d].angle=this.bullets[a].angle,b.enemy[d].cooldown=100,C++,b.enemy[d].death={x:this.bullets[a].x,y:this.bullets[a].y});this.bullets.splice(a,
1);break}void 0!==this.bullets[a]&&(0>~~this.bullets[a].x||~~this.bullets[a].x>e.width||0>~~this.bullets[a].y||~~this.bullets[a].y>e.height)&&this.bullets.splice(a,1)}},render:function(){j&&(c.shadowColor="rgba(0,0,0,1)");j&&(c.shadowBlur=5);j&&(c.shadowOffsetX=3);j&&(c.shadowOffsetY=3);c.fillStyle="#0f0";c.fillRect(f.x-4,f.y-4,8,8);j&&(c.shadowColor="rgba(255,255,0,0)");c.fillStyle="rgba(255,255,255,1)";for(var a in this.bullets)c.fillRect(~~this.bullets[a].x,~~this.bullets[a].y,3,3)}};b={enemy:[],
behaviors:{wanderChase:function(a){var c=Math.atan2(f.x-b.enemy[a].x,f.y-b.enemy[a].y);0>b.enemy[a].cooldown&&(b.enemy[a].angle=c,b.enemy[a].cooldown=~~(900*Math.random())+300);c=~~(100*b.enemy[a].angle);b.enemy[a].x+=q[c]*b.enemy[a].speed*i;b.enemy[a].y+=r[c]*b.enemy[a].speed*i;b.enemy[a].cooldown-=i},chase:function(a){b.enemy[a].angle=Math.atan2(f.x-b.enemy[a].x,f.y-b.enemy[a].y);var c=~~(100*b.enemy[a].angle);b.enemy[a].x+=q[c]*b.enemy[a].speed*i;b.enemy[a].y+=r[c]*b.enemy[a].speed*i},wander:function(a){b.enemy[a].angle>
F&&(b.enemy[a].angle-=D);b.enemy[a].angle<-F&&(b.enemy[a].angle+=D);0>b.enemy[a].x&&0>b.enemy[a].angle&&(b.enemy[a].angle=-b.enemy[a].angle);b.enemy[a].x>e.width&&0<b.enemy[a].angle&&(b.enemy[a].angle=-b.enemy[a].angle);0>b.enemy[a].y&&(b.enemy[a].angle<-l&&(b.enemy[a].angle=-l+(-l-b.enemy[a].angle)),b.enemy[a].angle>l&&(b.enemy[a].angle=l+(l-b.enemy[a].angle)));b.enemy[a].y>e.height&&(0>b.enemy[a].angle&&b.enemy[a].angle>-l&&(b.enemy[a].angle=-l+(-l-b.enemy[a].angle)),0<b.enemy[a].angle&&b.enemy[a].angle<
l&&(b.enemy[a].angle=l+(l-b.enemy[a].angle)));var c=~~(100*b.enemy[a].angle);b.enemy[a].x+=q[c]*b.enemy[a].speed*i;b.enemy[a].y+=r[c]*b.enemy[a].speed*i}},types:[{size:36,speed:0.038,hp:1,color:"rgba(255,0,0",behavior:"wander"},{size:20,speed:0.082,hp:1,color:"rgba(255,100,0",behavior:"wander"},{size:52,speed:0.022,hp:3,color:"rgba(255,0,120",behavior:"chase"},{size:28,speed:0.102,hp:2,color:"rgba(255,255,0",behavior:"wanderChase",cooldown:2900},{size:22,speed:0.064,hp:1,color:"rgba(0,255,255",behavior:"chase"},
{size:42,speed:0.032,hp:5,color:"rgba(255,155,255",behavior:"wander"}],spawnEnemy:function(a,b,c){var c=c+"",a={x:a,y:b,angle:Math.atan2(f.x-a,f.y-b)},e;for(e in this.types[c])a[e]=a[e]?a[e]:this.types[c][e];this.enemy.push(a)},logic:function(){if(x>100*Math.random()){var a=~~(4*Math.random()),c=~~(Math.random()*~~x);c>this.types.length-1&&(c=this.types.length-1);switch(a){case 0:this.spawnEnemy(~~(Math.random()*e.width),0,c);break;case 1:this.spawnEnemy(~~(Math.random()*e.width),e.height,c);break;
case 2:this.spawnEnemy(0,~~(Math.random()*e.height),c);break;case 3:this.spawnEnemy(e.width,~~(Math.random()*e.height),c)}}for(var d in b.enemy)void 0!==this.enemy[d]&&this.enemy[d].hp&&(this.behaviors[this.enemy[d].behavior](d),this.enemy[d].x<f.x+(this.enemy[d].size>>1)&&(this.enemy[d].x>f.x-(this.enemy[d].size>>1)&&this.enemy[d].y<f.y+(this.enemy[d].size>>1)&&this.enemy[d].y>f.y-(this.enemy[d].size>>1))&&(clearInterval(G),y=!1))},render:function(){var a=1,b,d,f,e,g;j&&(c.shadowBlur=5);j&&(c.shadowOffsetX=
3);j&&(c.shadowOffsetY=3);for(var h in this.enemy)if(void 0!==this.enemy[h])if(g=this.enemy[h].size,this.enemy[h].hp)j&&(c.shadowColor="rgba(0,0,0,1)"),e=this.enemy[h].color+",1)",c.fillStyle!==e&&(c.fillStyle=this.enemy[h].color+",1)"),c.fillRect(~~this.enemy[h].x-(g>>1),~~this.enemy[h].y-(g>>1),g,g);else if(this.enemy[h].cooldown-=0.1*i,e=this.enemy[h].cooldown){j&&(c.shadowColor="rgba(0,0,0,0)");if(84<e){a=3;c.strokeStyle="rgba(255, 255, 0, 1)";c.lineWidth=2;c.beginPath();d=Math.random()*(110-
e);for(f=Math.random()*(140-e);--a;)b=~~(628*Math.random()-314),c.moveTo(~~(this.enemy[h].death.x+q[b]*d),~~(this.enemy[h].death.y+r[b]*d)),c.lineTo(~~(this.enemy[h].death.x+q[b]*f),~~(this.enemy[h].death.y+r[b]*f));c.stroke();c.closePath()}cacheIndex=~~(100*this.enemy[h].angle);this.enemy[h].x+=q[cacheIndex]*0.01*e;this.enemy[h].y+=r[cacheIndex]*0.01*e;a=(e/100).toFixed(2);c.fillStyle=this.enemy[h].color+","+a+")";g+=~~(g*((100-e)/100));c.fillRect(~~this.enemy[h].x-(g>>1),~~this.enemy[h].y-(g>>1),
g,g)}else this.enemy.splice(h,1)}}}function B(){if(!y||A)return!1;var a=Date.now();i=a-w;x+=2E-5*i;E++;z+=i;w=a;f.logic();b.logic();e.render();b.render();f.render();t.render();n({color:"#f0f",text:"Score: "+C,x:80,y:30});a=~~(E/(z/1E3));n({color:"#f0f",text:"FPS: "+a,x:80,y:55});j&&(50>a&&1E4<z)&&(c.shadowColor="rgba(0,0,0,0)",j=!1);y||u();requestAnimationFrame(B)}var k,c,f={},e={},b={},x=0.7,C=0,G,y=!1,A=!1,F=Math.PI,l=Math.PI/2,D=2*Math.PI,p,m,r,q,v=200*D>>0,t={},i=0,E=0,z=0,j=!0,w=Date.now();q=
[];for(var s=-v;s<v;s++)q[s]=Math.sin(s/100);r=[];for(s=-v;s<v;s++)r[s]=Math.cos(s/100);p=900;m=660;k=document.getElementById("gamecanvas");c=k.getContext("2d");bgcanvas=document.getElementById("bgcanvas");bgctx=bgcanvas.getContext("2d");k.setAttribute("width",p);k.setAttribute("height",m);bgcanvas.setAttribute("width",p);bgcanvas.setAttribute("height",m);v=function(){var a=document.getElementById("bgimg");e.bgimg={img:a,width:a.width,height:a.height};bgctx.drawImage(e.bgimg.img,0,0,e.bgimg.width,
e.bgimg.height,0,0,p,m)};document.getElementById("bgimg").onload=v;document.getElementById("bgimg").complete&&v();e={width:p,height:m,offset:{left:window.innerWidth/2-k.width/2,top:k.offsetTop},image:"gravel.png",render:function(){j&&(c.shadowColor="rgba(0,0,0,0)");k.width=k.width}};t={x:0,y:0,render:function(){j&&(c.shadowColor="rgba(0,0,0,0)");c.strokeStyle="#0ff";c.strokeRect(t.x-4,t.y-4,8,8)}};j&&(c.shadowColor="rgba(0,0,0,0)");c.fillStyle="#000";c.fillRect(0,0,p,m);document.onmousemove=function(a){t.x=
(a.pageX-e.offset.left)/1;t.y=(a.pageY-e.offset.top)/1};document.onmousedown=function(a){f.fireShot();f.firing=!0;f.cooldown=20;a.stopPropagation();return!1};document.onmouseup=function(){f.firing=!1};window.onkeydown=function(a){switch(a.keyCode){case 87:f.moveUp=!0;break;case 65:f.moveLeft=!0;break;case 68:f.moveRight=!0;break;case 83:f.moveDown=!0;break;case 32:y?A?(w=Date.now(),A=!1,requestAnimationFrame(B)):(n({text:"PAUSED",size:60,color:"#538"}),n({text:"Press space to unpause.",y:(m>>1)+100}),
A=!0,z=E=0):(y=!0,g(),requestAnimationFrame(B))}};window.onkeyup=function(a){switch(a.keyCode){case 87:f.moveUp=!1;break;case 65:f.moveLeft=!1;break;case 68:f.moveRight=!1;break;case 83:f.moveDown=!1}};u();g()})();
