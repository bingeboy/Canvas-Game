var canvas,ctx,player={},field={},canvasScale=1,enemies={},frame=0.7,score=0,to,gameOn=!1,paused=!1,cpi=Math.PI,cpi2=Math.PI/2,cpi4=Math.PI/4,cpi3=cpi+cpi2,cpi360=2*Math.PI,cwidth,cheight,fC,fS,fakeLimit=200*cpi360>>0,crosshair={},minusClock=0,fpsCount=0,fpsTimer=0,shadowEnabled=!0,gameClock=Date.now();fS=[];for(var i=-fakeLimit;i<fakeLimit;i++)fS[i]=Math.sin(i/100);fC=[];for(i=-fakeLimit;i<fakeLimit;i++)fC[i]=Math.cos(i/100);
function drawText(a){var b={color:"#fff",align:"center",size:15,x:cwidth>>1,y:cheight>>1},c;for(c in b)a[c]=a[c]?a[c]:b[c];if("undefined"===typeof a.text||0===a.text.length)return!1;shadowEnabled&&(ctx.shadowColor="rgba(0,0,0,0)");ctx.font=a.size+"px arial";b=ctx.measureText(a.text).width;ctx.fillStyle="rgba(0,0,0,0.7)";ctx.fillRect(a.x-(b>>1)-10,a.y-8,b+17,a.size+18);ctx.textAlign=a.align;ctx.textBaseline="top";ctx.fillStyle=a.color;ctx.fillText(a.text,a.x,a.y)}
function preResetGame(){var a=cwidth>>1,b=~~(0.48*cheight),c=~~(0.75*cheight);shadowEnabled&&(ctx.shadowColor="rgba(0,0,0,0)");ctx.textBaseline="alphabetic";ctx.fillStyle="rgba(0,0,0,0.7)";ctx.fillRect(a-255,b-88,510,106);ctx.font="98px arial";ctx.fillStyle="#538";ctx.textAlign="center";ctx.fillText("SQUARE'D",a,b);ctx.font="100px arial";ctx.lineWidth=1;ctx.strokeStyle="#a7f";ctx.textAlign="center";ctx.strokeText("SQUARE'D",a,b);drawText({text:"Press space to start",y:c-18});drawText({text:"Controls: W, A, S, D to move; Mouse to aim and fire",
y:c+18});gameClock=Date.now()}
function resetGame(){gameClock=Date.now();score=0;frame=0.7;player={x:~~(cwidth/2),y:~~(cheight/2),hp:100,moveUp:!1,moveDown:!1,moveLeft:!1,moveRight:!1,firing:!1,cooldown:25,bullets:[],fireShot:function(){this.bullets.push({x:this.x,y:this.y,angle:Math.atan2(crosshair.x-this.x,crosshair.y-this.y)})},logic:function(){this.moveLeft&&(0<this.x&&!this.moveRight)&&(this.x-=0.12*minusClock);player.moveRight&&(this.x<field.width&&!this.moveLeft)&&(this.x+=0.12*minusClock);this.moveUp&&(0<this.y&&!this.moveDown)&&
(this.y-=0.12*minusClock);this.moveDown&&(this.y<field.height&&!this.moveUp)&&(this.y+=0.12*minusClock);if(this.firing&&0>=(this.cooldown-=0.2*minusClock))this.fireShot(),this.cooldown=25;for(var a in this.bullets){var b=~~(100*this.bullets[a].angle);this.bullets[a].x+=fS[b]*0.5*minusClock;this.bullets[a].y+=fC[b]*0.5*minusClock;for(var c in enemies.enemy)if(void 0!==this.bullets[a]&&this.bullets[a].x<enemies.enemy[c].x+enemies.enemy[c].size&&this.bullets[a].x>enemies.enemy[c].x-enemies.enemy[c].size&&
this.bullets[a].y<enemies.enemy[c].y+enemies.enemy[c].size&&this.bullets[a].y>enemies.enemy[c].y-enemies.enemy[c].size&&0<enemies.enemy[c].hp){--enemies.enemy[c].hp||(enemies.enemy[c].angle=this.bullets[a].angle,enemies.enemy[c].cooldown=100,score++,enemies.enemy[c].death={x:this.bullets[a].x,y:this.bullets[a].y});this.bullets.splice(a,1);break}void 0!==this.bullets[a]&&(0>~~this.bullets[a].x||~~this.bullets[a].x>field.width||0>~~this.bullets[a].y||~~this.bullets[a].y>field.height)&&this.bullets.splice(a,
1)}},render:function(){shadowEnabled&&(ctx.shadowColor="rgba(0,0,0,1)");shadowEnabled&&(ctx.shadowBlur=5);shadowEnabled&&(ctx.shadowOffsetX=3);shadowEnabled&&(ctx.shadowOffsetY=3);ctx.fillStyle="#0f0";ctx.fillRect(player.x-4,player.y-4,8,8);shadowEnabled&&(ctx.shadowColor="rgba(255,255,0,0)");ctx.fillStyle="rgba(255,255,255,1)";for(var a in this.bullets)ctx.fillRect(~~this.bullets[a].x,~~this.bullets[a].y,3,3)}};enemies={enemy:[],behaviors:{wanderChase:function(a){var b=Math.atan2(player.x-enemies.enemy[a].x,
player.y-enemies.enemy[a].y);0>enemies.enemy[a].cooldown&&(enemies.enemy[a].angle=b,enemies.enemy[a].cooldown=~~(900*Math.random())+300);b=~~(100*enemies.enemy[a].angle);enemies.enemy[a].x+=fS[b]*enemies.enemy[a].speed*minusClock;enemies.enemy[a].y+=fC[b]*enemies.enemy[a].speed*minusClock;enemies.enemy[a].cooldown-=minusClock},chase:function(a){enemies.enemy[a].angle=Math.atan2(player.x-enemies.enemy[a].x,player.y-enemies.enemy[a].y);var b=~~(100*enemies.enemy[a].angle);enemies.enemy[a].x+=fS[b]*
enemies.enemy[a].speed*minusClock;enemies.enemy[a].y+=fC[b]*enemies.enemy[a].speed*minusClock},wander:function(a){enemies.enemy[a].angle>cpi&&(enemies.enemy[a].angle-=cpi360);enemies.enemy[a].angle<-cpi&&(enemies.enemy[a].angle+=cpi360);0>enemies.enemy[a].x&&0>enemies.enemy[a].angle&&(enemies.enemy[a].angle=-enemies.enemy[a].angle);enemies.enemy[a].x>field.width&&0<enemies.enemy[a].angle&&(enemies.enemy[a].angle=-enemies.enemy[a].angle);0>enemies.enemy[a].y&&(enemies.enemy[a].angle<-cpi2&&(enemies.enemy[a].angle=
-cpi2+(-cpi2-enemies.enemy[a].angle)),enemies.enemy[a].angle>cpi2&&(enemies.enemy[a].angle=cpi2+(cpi2-enemies.enemy[a].angle)));enemies.enemy[a].y>field.height&&(0>enemies.enemy[a].angle&&enemies.enemy[a].angle>-cpi2&&(enemies.enemy[a].angle=-cpi2+(-cpi2-enemies.enemy[a].angle)),0<enemies.enemy[a].angle&&enemies.enemy[a].angle<cpi2&&(enemies.enemy[a].angle=cpi2+(cpi2-enemies.enemy[a].angle)));var b=~~(100*enemies.enemy[a].angle);enemies.enemy[a].x+=fS[b]*enemies.enemy[a].speed*minusClock;enemies.enemy[a].y+=
fC[b]*enemies.enemy[a].speed*minusClock}},types:[{size:36,speed:0.038,hp:1,color:"rgba(255,0,0",behavior:"wander"},{size:20,speed:0.082,hp:1,color:"rgba(255,100,0",behavior:"wander"},{size:52,speed:0.022,hp:3,color:"rgba(255,0,120",behavior:"chase"},{size:28,speed:0.102,hp:2,color:"rgba(255,255,0",behavior:"wanderChase",cooldown:2900},{size:22,speed:0.064,hp:1,color:"rgba(0,255,255",behavior:"chase"},{size:42,speed:0.032,hp:5,color:"rgba(255,155,255",behavior:"wander"}],spawnEnemy:function(a,b,c){var c=
c+"",a={x:a,y:b,angle:Math.atan2(player.x-a,player.y-b)},g;for(g in this.types[c])a[g]=a[g]?a[g]:this.types[c][g];this.enemy.push(a)},logic:function(){if(frame>100*Math.random()){var a=~~(4*Math.random()),b=~~(Math.random()*~~frame);b>this.types.length-1&&(b=this.types.length-1);switch(a){case 0:this.spawnEnemy(~~(Math.random()*field.width),0,b);break;case 1:this.spawnEnemy(~~(Math.random()*field.width),field.height,b);break;case 2:this.spawnEnemy(0,~~(Math.random()*field.height),b);break;case 3:this.spawnEnemy(field.width,
~~(Math.random()*field.height),b)}}for(var c in enemies.enemy)void 0!==this.enemy[c]&&this.enemy[c].hp&&(this.behaviors[this.enemy[c].behavior](c),this.enemy[c].x<player.x+(this.enemy[c].size>>1)&&(this.enemy[c].x>player.x-(this.enemy[c].size>>1)&&this.enemy[c].y<player.y+(this.enemy[c].size>>1)&&this.enemy[c].y>player.y-(this.enemy[c].size>>1))&&(clearInterval(to),gameOn=!1))},render:function(){var a=1,b,c,g,f,e;shadowEnabled&&(ctx.shadowBlur=5);shadowEnabled&&(ctx.shadowOffsetX=3);shadowEnabled&&
(ctx.shadowOffsetY=3);for(var d in this.enemy)if(void 0!==this.enemy[d])if(e=this.enemy[d].size,this.enemy[d].hp)shadowEnabled&&(ctx.shadowColor="rgba(0,0,0,1)"),f=this.enemy[d].color+",1)",ctx.fillStyle!==f&&(ctx.fillStyle=this.enemy[d].color+",1)"),ctx.fillRect(~~this.enemy[d].x-(e>>1),~~this.enemy[d].y-(e>>1),e,e);else if(this.enemy[d].cooldown-=0.1*minusClock,f=this.enemy[d].cooldown){shadowEnabled&&(ctx.shadowColor="rgba(0,0,0,0)");if(84<f){a=3;ctx.strokeStyle="rgba(255, 255, 0, 1)";ctx.lineWidth=
2;ctx.beginPath();c=Math.random()*(110-f);for(g=Math.random()*(140-f);--a;)b=~~(628*Math.random()-314),ctx.moveTo(~~(this.enemy[d].death.x+fS[b]*c),~~(this.enemy[d].death.y+fC[b]*c)),ctx.lineTo(~~(this.enemy[d].death.x+fS[b]*g),~~(this.enemy[d].death.y+fC[b]*g));ctx.stroke();ctx.closePath()}cacheIndex=~~(100*this.enemy[d].angle);this.enemy[d].x+=fS[cacheIndex]*0.01*f;this.enemy[d].y+=fC[cacheIndex]*0.01*f;a=(f/100).toFixed(2);ctx.fillStyle=this.enemy[d].color+","+a+")";e+=~~(e*((100-f)/100));ctx.fillRect(~~this.enemy[d].x-
(e>>1),~~this.enemy[d].y-(e>>1),e,e)}else this.enemy.splice(d,1)}}}function fail(){preResetGame()}function resizeEverything(){var a=cwidth/cheight,b=$(window).width(),c=$(window).height();b/c>a?($("#gamecanvas").css({height:c,width:c*a}),canvasScale=c*a/cwidth):($("#gamecanvas").css({height:b*a,width:b}),canvasScale=b/cwidth)}
$(document).ready(function(){function a(){if(!gameOn||paused)return!1;var b=Date.now();minusClock=b-gameClock;frame+=2E-5*minusClock;fpsCount++;fpsTimer+=minusClock;gameClock=b;player.logic();enemies.logic();field.render();enemies.render();player.render();crosshair.render();drawText({color:"#f0f",text:"Score: "+score,x:80,y:30});b=~~(fpsCount/(fpsTimer/1E3));drawText({color:"#f0f",text:"FPS: "+b,x:80,y:55});shadowEnabled&&(50>b&&1E4<fpsTimer)&&(ctx.shadowColor="rgba(0,0,0,0)",shadowEnabled=!1);gameOn||
fail();requestAnimationFrame(a)}cwidth=900;cheight=660;canvas=document.getElementById("gamecanvas");ctx=canvas.getContext("2d");bgcanvas=document.getElementById("bgcanvas");bgctx=bgcanvas.getContext("2d");canvas.setAttribute("width",cwidth);canvas.setAttribute("height",cheight);bgcanvas.setAttribute("width",cwidth);bgcanvas.setAttribute("height",cheight);$("#bgimg").one("load",function(){var a=$(this);field.bgimg={img:document.getElementById("bgimg"),width:a.width(),height:a.height()};bgctx.drawImage(field.bgimg.img,
0,0,field.bgimg.width,field.bgimg.height,0,0,cwidth,cheight)}).each(function(){this.complete&&$(this).trigger("load")});field={width:cwidth,height:cheight,offset:$("#gamecanvas").offset(),image:"gravel.png",render:function(){shadowEnabled&&(ctx.shadowColor="rgba(0,0,0,0)");canvas.width=canvas.width}};crosshair={x:0,y:0,render:function(){shadowEnabled&&(ctx.shadowColor="rgba(0,0,0,0)");ctx.strokeStyle="#0ff";ctx.strokeRect(crosshair.x-4,crosshair.y-4,8,8)}};shadowEnabled&&(ctx.shadowColor="rgba(0,0,0,0)");
ctx.fillStyle="#000";ctx.fillRect(0,0,cwidth,cheight);$(document).mousemove(function(a){crosshair.x=(a.pageX-field.offset.left)/canvasScale;crosshair.y=(a.pageY-field.offset.top)/canvasScale});$(document).mousedown(function(a){player.fireShot();player.firing=!0;player.cooldown=20;a.stopPropagation();return!1});$(document).mouseup(function(){player.firing=!1});$(window).keydown(function(b){switch(b.keyCode){case 87:player.moveUp=!0;break;case 65:player.moveLeft=!0;break;case 68:player.moveRight=!0;
break;case 83:player.moveDown=!0;break;case 32:gameOn?paused?(gameClock=Date.now(),paused=!1,requestAnimationFrame(a)):(drawText({text:"PAUSED",size:60,color:"#538"}),drawText({text:"Press space to unpause.",y:(cheight>>1)+100}),paused=!0,fpsTimer=fpsCount=0):(gameOn=!0,resetGame(),requestAnimationFrame(a))}});$(window).keyup(function(a){switch(a.keyCode){case 87:player.moveUp=!1;break;case 65:player.moveLeft=!1;break;case 68:player.moveRight=!1;break;case 83:player.moveDown=!1}});preResetGame();
resetGame()});
