for(var c=!0,e=!1,g=0,i=["ms","moz","webkit","o"],k=0;k<i.length&&!window.requestAnimationFrame;++k)window.requestAnimationFrame=window[i[k]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[k]+"CancelAnimationFrame"]||window[i[k]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var b=(new Date).getTime(),d=Math.max(0,16-(b-g)),h=window.setTimeout(function(){a(b+d)},d);g=b+d;return h});
window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});function l(a){var b={color:"#fff",align:"center",size:15,x:n>>1,y:p>>1},d;for(d in b)a[d]=a[d]?a[d]:b[d];"undefined"===typeof a.text||0===a.text.length||(q&&(r.shadowColor="rgba(0,0,0,0)"),r.font=a.size+"px arial",b=r.measureText(a.text).width,r.fillStyle="rgba(0,0,0,0.7)",r.fillRect(a.x-(b>>1)-10,a.y-8,b+17,a.size+18),r.textAlign=a.align,r.textBaseline="top",r.fillStyle=a.color,r.fillText(a.text,a.x,a.y))}
function s(){var a=n>>1,b=~~(0.48*p),d=~~(0.75*p);q&&(r.shadowColor="rgba(0,0,0,0)");r.textBaseline="alphabetic";r.fillStyle="rgba(0,0,0,0.7)";r.fillRect(a-255,b-88,510,106);r.font="98px arial";r.fillStyle="#538";r.textAlign="center";r.fillText("SQUARE'D",a,b);r.font="100px arial";r.lineWidth=1;r.strokeStyle="#a7f";r.textAlign="center";r.strokeText("SQUARE'D",a,b);l({text:"Press space to start",y:d-18});l({text:"Controls: Arrow keys or W, A, S, D to move; Mouse to aim and fire",y:d+18});gameClock=
Date.now()}
function t(){gameClock=Date.now();u=0;v=1.9;w={x:~~(n/2),y:~~(p/2),d:100,t:e,q:e,r:e,s:e,v:e,b:25,k:[],B:function(){this.k.push({x:this.x,y:this.y,a:Math.atan2(x.x-this.x,x.y-this.y)})},w:function(){this.r&&(0<this.x&&!this.s)&&(this.x-=0.12*y);w.s&&(this.x<A.width&&!this.r)&&(this.x+=0.12*y);this.t&&(0<this.y&&!this.q)&&(this.y-=0.12*y);this.q&&(this.y<A.height&&!this.t)&&(this.y+=0.12*y);if(this.v&&0>=(this.b-=0.2*y))this.B(),this.b=25;for(var a,b,d,h,j=0,m=this.k.length;j<m;++j){h=e;a=this.k[j];
cacheIndex=~~(100*a.a);a.x+=B[cacheIndex]*0.7*y;a.y+=C[cacheIndex]*0.7*y;d=0;for(var f=Object.keys(D.c),z=f.length;d<z;++d)if(b=D.c[f[d]],void 0!==a&&a.x<b.x+b.size&&a.x>b.x-b.size&&a.y<b.y+b.size&&a.y>b.y-b.size&&"dead"!==b.status){b.d--;0<b.d?(b.status="wounded",b.x+=6*B[cacheIndex],b.y+=6*C[cacheIndex]):(b.status="dead",b.a=a.a,b.b=100,u++,b.p={x:a.x,y:a.y});h=c;break}if(!h&&(0>a.x||a.x>A.width||0>a.y||a.y>A.height))h=c;h&&(this.k.splice(j,1),m--,j--)}},i:function(){var a;q&&(r.shadowColor="rgba(0,0,0,1)",
r.shadowBlur=15,r.shadowOffsetX=0,r.shadowOffsetY=0);r.fillStyle="#0f0";r.fillRect(w.x-4,w.y-4,8,8);q&&(r.shadowColor="rgba(255,255,0,1)");r.strokeStyle="rgba(255, 255, 255, 1)";r.lineWidth=4;r.beginPath();for(var b,d=0,h=Object.keys(this.k),j=h.length;d<j;++d)b=this.k[h[d]],a=~~(100*Math.atan2(w.x-~~b.x,w.y-~~b.y)),r.moveTo(~~b.x,~~b.y),r.lineTo(~~b.x+18*B[a],~~b.y+18*C[a]);r.stroke();r.closePath()}};D={c:{},m:{wanderChase:function(a){var a=D.c[a],b=Math.atan2(w.x-a.x,w.y-a.y);0>a.b&&(a.a=b,a.b=
~~(3900*Math.random())+2300);b=~~(100*a.a);a.x+=B[b]*a.speed*y;a.y+=C[b]*a.speed*y;a.b-=y},chase:function(a){a=D.c[a];a.a=Math.atan2(w.x-a.x,w.y-a.y);var b=~~(100*a.a);a.x+=B[b]*a.speed*y;a.y+=C[b]*a.speed*y},divebomb:function(a){var b=~~(100*D.c[a].a),a=D.c[a];a.x+=B[b]*a.speed*y;a.y+=C[b]*a.speed*y;if(0>a.x||a.x>A.width||0>a.y||a.y>A.height)a.d=0,a.b=0},wanderCurve:function(a){var b=D.c[a];0<b.h&&(b.h-=y,0>=b.h&&(b.h=6E3,b.j=0.04*Math.random()-0.02));b.a+=b.j;D.m.wander(a)},ringerHub:function(a){var b=
D.c[a];if(b.n){for(var d=E/b.n,h=50*Math.random()+50,j=[-1,1][Math.round(Math.random())]*(0.04*Math.random()+0.06);b.n--;)D.o({x:b.x,y:b.y,size:32,a:b.n*d,f:a,b:1500,C:h,e:"ringer",color:"rgba(112,255,152",d:1,j:j,status:"alive",speed:b.speed,l:b.l-1});b.n=0}D.m.wanderCurve(a)},ringer:function(a){var b=D.c[a];if(""===b.f||"dead"===D.c[b.f].status)return b.e="wander",D.m.wander(a),c;var a=b.C,d=D.c[b.f];0<b.b&&(b.b-=y,a=(1500-b.b)/1500*b.C);var h=~~(100*b.a);b.x=C[h]*a+d.x;b.y=B[h]*a+d.y;b.a+=b.j;
b.a>F&&(b.a-=E);b.a<-F&&(b.a+=E)},centipede:function(a){var b=D.c[a];0<b.b&&(b.b-=y,0>=b.b&&b.l&&(D.o({x:b.z,y:b.A,z:b.z,A:b.A,size:b.size,a:b.a,h:6E3,j:0.04*Math.random()-0.02,f:a,b:200,e:"centipede",color:b.color,d:1,status:"alive",speed:b.speed,l:b.l-1}),b.l=0));if(""===b.f||"dead"===D.c[b.f].status)""!==b.f&&(b.f=""),b.color="rgba(220,0,220",D.m.wanderCurve(a);else{b.color="rgba(140,0,140";var a=D.c[b.f],d=b.x-a.x,h=b.y-a.y;b.speed=25<Math.sqrt(d*d+h*h)?0.112:0.05;b.a=Math.atan2(a.x-b.x,a.y-b.y);
a=~~(100*b.a);b.x+=B[a]*b.speed*y;b.y+=C[a]*b.speed*y}},wander:function(a){a=D.c[a];a.a>F&&(a.a-=E);a.a<-F&&(a.a+=E);0>a.x?0>a.a&&(a.a=-a.a):a.x>A.width&&0<a.a&&(a.a=-a.a);0>a.y?(a.a<-G&&(a.a=-G+(-G-a.a)),a.a>G&&(a.a=G+(G-a.a))):a.y>A.height&&(0>a.a&&a.a>-G&&(a.a=-G+(-G-a.a)),0<a.a&&a.a<G&&(a.a=G+(G-a.a)));var b=~~(100*a.a);a.x+=B[b]*a.speed*y;a.y+=C[b]*a.speed*y}},types:[{size:46,speed:0.042,d:1,color:"rgba(64,64,255",e:"wander",b:0,g:1},{size:22,speed:0.092,d:1,color:"rgba(255,100,0",e:"wander",
b:0,g:1},{size:52,speed:0.022,d:3,color:"rgba(0,0,180",e:"chase",b:0,g:1},{size:22,speed:0.052,d:4,color:"rgba(64,124,84",e:"ringerHub",b:6E3,g:0.1},{size:31,speed:0.112,d:1,color:"rgba(220,0,220",e:"centipede",b:200,g:0.1},{size:28,speed:0.09,d:2,color:"rgba(255,0,0",e:"wanderChase",b:3900,g:1},{size:20,speed:0.064,d:1,color:"rgba(0,255,255",e:"chase",b:0,g:1},{size:30,speed:0.17,d:1,color:"rgba(255,255,0",e:"divebomb",b:0,g:1},{size:42,speed:0.032,d:5,color:"rgba(0,0,80",e:"wander",b:0,g:1}],o:function(a){H++;
var b="e"+H;this.c[b]=a;return b},w:function(){if(v>100*Math.random()){var a,b=~~(4*Math.random());a=~~(Math.random()*Math.min(~~v,this.types.length-1));a=this.types[a];if(1===a.g||Math.random()<a.g){a={size:a.size,speed:a.speed,d:a.d,color:a.color,e:a.e,b:a.b,status:"alive"};switch(b){case 0:a.x=~~(Math.random()*A.width);a.y=0;break;case 1:a.x=~~(Math.random()*A.width);a.y=A.height;break;case 2:a.x=0;a.y=~~(Math.random()*A.height);break;case 3:a.x=A.width,a.y=~~(Math.random()*A.height)}a.a=Math.atan2(w.x-
a.x,w.y-a.y);switch(a.e){case "ringerHub":a.n=~~(4*Math.random())+8;a.j=0.04*Math.random()-0.02;a.h=6E3;this.o(a);break;case "centipede":a.f="";a.l=~~(10*Math.random())+8;a.z=a.x;a.A=a.y;a.j=0.04*Math.random()-0.02;a.h=6E3;this.o(a);break;default:this.o(a)}}}a=0;for(var d=Object.keys(this.c),h=d.length;a<h;++a)b=this.c[d[a]],void 0!==b&&"dead"!==b.status&&(this.m[b.e](d[a]),b.x<w.x+(b.size>>1)&&(b.x>w.x-(b.size>>1)&&b.y<w.y+(b.size>>1)&&b.y>w.y-(b.size>>1))&&(clearInterval(I),J=e))},i:function(){var a=
1,b,d,h,j,m;q&&(r.shadowBlur=5,r.shadowOffsetX=3,r.shadowOffsetY=3);for(var f,z=0,K=Object.keys(this.c),U=K.length;z<U;++z)if(f=this.c[K[z]],m=f.size,"dead"!==f.status)q&&(r.shadowColor="rgba(0,0,0,1)"),"wounded"!==f.status?j=f.color+",1)":(f.status="alive",j="rgba(255,255,255,1)"),r.fillStyle!==j&&(r.fillStyle=j),r.fillRect(~~f.x-(m>>1),~~f.y-(m>>1),m,m);else{var R=f.color;100===f.b&&(R="rgba(255,255,255");f.b-=0.1*y;j=f.b;if(0>=j)delete this.c[K[z]];else{q&&(r.shadowColor="rgba(0,0,0,0)");if(90<
j){a=3;r.strokeStyle="rgba(255, 255, 0, 1)";r.lineWidth=4;r.beginPath();d=Math.random()*(110-j);for(h=Math.random()*(140-j);--a;)b=~~(628*Math.random()-314),r.moveTo(~~(f.p.x+B[b]*d),~~(f.p.y+C[b]*d)),r.lineTo(~~(f.p.x+B[b]*h),~~(f.p.y+C[b]*h));r.stroke();r.closePath()}cacheIndex=~~(100*f.a);f.x+=B[cacheIndex]*0.03*j;f.y+=C[cacheIndex]*0.03*j;a=(j/100).toFixed(2);r.fillStyle=R+","+a+")";m+=~~(m*((100-j)/100));r.fillRect(~~f.x-(m>>1),~~f.y-(m>>1),m,m)}}}}}
function L(){if(!J||M)return e;var a=Date.now();y=a-gameClock;v+=2E-5*y;N++;O+=y;gameClock=a;w.w();D.w();A.i();D.i();w.i();x.i();l({color:"#f0f",text:"Score: "+u,x:80,y:30});a=~~(N/(O/1E3));l({color:"#f0f",text:"FPS: "+a,x:80,y:55});q&&(50>a&&1E4<O)&&(r.shadowColor="rgba(0,0,0,0)",q=e);J||s();requestAnimationFrame(L)}var P,r,w={},A={},D={},v=0.7,u=0,I,J=e,M=e,F=Math.PI,G=Math.PI/2,E=2*Math.PI,n,p,C,B,Q=200*E>>0,x={},y=0,N=0,O=0,q=c,H=0;gameClock=Date.now();B=[];
for(var S=-Q;S<Q;S++)B[S]=Math.sin(S/100);C=[];for(S=-Q;S<Q;S++)C[S]=Math.cos(S/100);n=900;p=660;P=document.getElementById("gamecanvas");r=P.getContext("2d");bgcanvas=document.getElementById("bgcanvas");bgctx=bgcanvas.getContext("2d");P.setAttribute("width",n);P.setAttribute("height",p);bgcanvas.setAttribute("width",n);bgcanvas.setAttribute("height",p);
function T(){var a=document.getElementById("bgimg");A.u={D:a,width:a.width,height:a.height};bgctx.drawImage(A.u.D,0,0,A.u.width,A.u.height,0,0,n,p)}document.getElementById("bgimg").onload=T;document.getElementById("bgimg").complete&&T();A={width:n,height:p,offset:{left:window.innerWidth/2-P.width/2,top:P.offsetTop},F:"gravel.png",i:function(){q&&(r.shadowColor="rgba(0,0,0,0)");P.width=P.width}};
x={x:0,y:0,i:function(){q&&(r.shadowColor="rgba(0,0,0,0)");r.strokeStyle="#0ff";r.strokeRect(x.x-4,x.y-4,8,8)}};q&&(r.shadowColor="rgba(0,0,0,0)");r.fillStyle="#000";r.fillRect(0,0,n,p);document.onmousemove=function(a){x.x=(a.pageX-A.offset.left)/1;x.y=(a.pageY-A.offset.top)/1};document.onmousedown=function(a){w.B();w.v=c;w.b=20;a.stopPropagation();return e};document.onmouseup=function(){w.v=e};
window.onkeydown=function(a){switch(a.keyCode){case 38:case 87:w.t=c;break;case 37:case 65:w.r=c;break;case 39:case 68:w.s=c;break;case 40:case 83:w.q=c;break;case 32:J?M?(gameClock=Date.now(),M=e,requestAnimationFrame(L)):(l({text:"PAUSED",size:60,color:"#538"}),l({text:"Press space to unpause.",y:(p>>1)+100}),M=c,O=N=0):(J=c,t(),requestAnimationFrame(L))}};
window.onkeyup=function(a){switch(a.keyCode){case 38:case 87:w.t=e;break;case 37:case 65:w.r=e;break;case 39:case 68:w.s=e;break;case 40:case 83:w.q=e}};s();t();
